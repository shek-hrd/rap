<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapture Accessible - Screen Capture for Blind Users</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- Skip to main content for screen readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Voice command status indicator -->
    <div id="voice-status" class="voice-status" role="status" aria-live="polite" aria-label="Voice command status"></div>

    <div class="container">
        <header role="banner">
            <h1>Rapture Accessible</h1>
            <p>Voice-Enabled Screen Capture & AI Analysis for Blind Users</p>
            <div class="status-announcements" role="status" aria-live="polite" aria-label="System status"></div>
        </header>

        <main id="main-content" role="main">
            <!-- Status Announcements - Hidden at top for screen readers -->
            <div class="status-announcements" role="status" aria-live="polite" aria-label="System status" style="position: absolute; left: -9999px;"></div>

            <!-- Control Panel - Top Section -->
            <section class="control-panel" role="region" aria-labelledby="control-panel-heading">
                <h2 id="control-panel-heading">Rapture Accessible Control Panel</h2>

                <!-- Sequential Actions - Enhanced Layout -->
                <div class="control-group sequential-actions-primary">
                    <h3>‚ö° Sequential Actions <span class="success-rate">Enhanced Success Rate</span></h3>
                    <div class="sequential-controls-horizontal">
                        <button id="quickSequence" class="btn btn-wide btn-primary sequential-btn" data-action="quick" aria-describedby="quick-sequence-desc">
                            <span class="btn-icon">‚ö°</span>
                            <span class="btn-text">Quick Sequence</span>
                            <span class="btn-subtitle">(Capture ‚Üí Analyze ‚Üí Save)</span>
                            <span class="progress-indicator"></span>
                        </button>
                        <button id="fullSequence" class="btn btn-wide btn-secondary sequential-btn" data-action="full" aria-describedby="full-sequence-desc">
                            <span class="btn-icon">üîÑ</span>
                            <span class="btn-text">Full Sequence</span>
                            <span class="btn-subtitle">(Screen ‚Üí Video ‚Üí Analyze ‚Üí Read ‚Üí Save)</span>
                            <span class="progress-indicator"></span>
                        </button>
                        <button id="emergencySequence" class="btn btn-wide btn-danger sequential-btn" data-action="emergency" aria-describedby="emergency-sequence-desc">
                            <span class="btn-icon">üö®</span>
                            <span class="btn-text">Emergency Sequence</span>
                            <span class="btn-subtitle">(Immediate Capture + Priority Analysis)</span>
                            <span class="progress-indicator"></span>
                        </button>
                    </div>
                    <div class="sequence-status" id="sequenceStatus" role="status" aria-live="polite">
                        <span class="status-text">Ready to execute sequence</span>
                        <div class="sequence-progress">
                            <div class="progress-steps" id="sequenceProgressSteps">
                                <span class="step" data-step="capture">Capture</span>
                                <span class="step" data-step="process">Process</span>
                                <span class="step" data-step="analyze">Analyze</span>
                                <span class="step" data-step="save">Save</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="main-controls">
                    <div class="control-group">
                        <h3>Screen Capture</h3>
                        <div class="button-group">
                            <button id="manualScreenCapture" class="btn btn-primary" aria-describedby="manual-screen-desc">
                                üì∏ Manual Screen Capture
                            </button>
                            <button id="autoCapture" class="btn btn-secondary" aria-describedby="auto-capture-desc">
                                üîÑ Auto Capture (3x)
                            </button>
                            <button id="emergencyCapture" class="btn btn-danger" aria-describedby="emergency-capture-desc">
                                üö® Emergency Capture
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Video Recording</h3>
                        <div class="button-group">
                            <button id="manualVideoCapture" class="btn btn-primary" aria-describedby="manual-video-desc">
                                üé• Manual Video Capture
                            </button>
                            <button id="toggleRecording" class="btn btn-success" aria-describedby="toggle-recording-desc">
                                ‚è∫Ô∏è Start Recording
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Analysis & Actions</h3>
                        <div class="button-group">
                            <button id="analyzeCapture" class="btn btn-info" disabled aria-describedby="analyze-current-desc">
                                ü§ñ Analyze Current Capture
                            </button>
                            <button id="readAloud" class="btn btn-success" disabled aria-describedby="read-aloud-desc">
                                üîä Read Analysis Aloud
                            </button>
                            <button id="saveCapture" class="btn btn-primary" disabled aria-describedby="save-capture-desc">
                                üíæ Save Capture
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Countdown Timer -->
                <div class="countdown-section" id="countdownSection" style="display: none;">
                    <div class="countdown-display">
                        <span id="countdownText">Next action in:</span>
                        <span id="countdownTimer" class="timer">10</span>
                        <span>seconds</span>
                    </div>
                    <div class="countdown-controls">
                        <button id="pauseCountdown" class="btn btn-warning">‚è∏Ô∏è Pause</button>
                        <button id="stopCountdown" class="btn btn-danger">‚èπÔ∏è Stop</button>
                        <button id="resumeCountdown" class="btn btn-success" style="display: none;">‚ñ∂Ô∏è Resume</button>
                    </div>
                </div>

                <!-- Settings - Collapsible -->
                <details class="settings-details">
                    <summary>‚öôÔ∏è Settings & Configuration</summary>
                    <div class="settings-content">
                        <div class="setting-group">
                            <label for="autoAnalyzeToggle">Auto-analyze captures:</label>
                            <input type="checkbox" id="autoAnalyzeToggle" checked aria-describedby="auto-analyze-desc">
                        </div>

                        <div class="setting-group">
                            <label for="aiProviderSelect">AI Provider:</label>
                            <select id="aiProviderSelect" aria-describedby="ai-provider-desc">
                                <option value="gemini">Gemini (Free)</option>
                                <option value="huggingface">Hugging Face</option>
                                <option value="openai">OpenAI GPT-4</option>
                            </select>
                        </div>

                        <div class="setting-group">
                            <label for="autoCaptureCount">Auto captures:</label>
                            <input type="number" id="autoCaptureCount" min="1" max="10" value="1">
                            <button id="updateAutoCaptureCount" class="btn btn-small">Update</button>
                        </div>

                        <div class="setting-group">
                            <label for="autoCaptureDelay">Delay (seconds):</label>
                            <input type="number" id="autoCaptureDelay" min="1" max="60" value="5">
                            <button id="updateAutoCaptureDelay" class="btn btn-small">Update</button>
                        </div>
                    </div>
                </details>
            </section>

            <!-- Live Preview & Analysis - Compact Layout -->
            <section class="preview-analysis-section" role="region" aria-labelledby="preview-heading">
                <div class="split-view">
                    <!-- Left: Preview -->
                    <div class="preview-panel">
                        <h3 id="preview-heading">Live Preview</h3>
                        <div class="preview-container">
                            <video id="previewVideo" autoplay muted style="display: none;" aria-label="Live video preview"></video>
                            <canvas id="previewCanvas" style="display: none;" aria-label="Screen capture preview"></canvas>
                            <img id="previewImage" alt="Screen capture preview" style="display: none;" aria-label="Screen capture image">
                            <div id="previewPlaceholder" class="preview-placeholder">
                                No preview available. Use capture buttons above to begin.
                            </div>
                        </div>
                    </div>

                    <!-- Right: Analysis -->
                    <div class="analysis-panel">
                        <h3>AI Analysis Results</h3>
                        <div class="analysis-content">
                            <textarea id="aiDescription" placeholder="AI analysis will appear here after capture..." readonly aria-label="AI analysis results"></textarea>
                        </div>
                        <div class="analysis-actions">
                            <button id="reanalyze" class="btn btn-small btn-secondary" disabled>üîÑ Re-analyze</button>
                            <button id="askQuestion" class="btn btn-small btn-info">‚ùì Ask Question</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Captures - Compact Gallery -->
            <section class="captures-section" role="region" aria-labelledby="captures-heading">
                <div class="section-header">
                    <h3 id="captures-heading">Recent Captures</h3>
                    <div class="section-actions">
                        <button id="clearAll" class="btn btn-small btn-danger">üóëÔ∏è Clear All</button>
                        <button id="exportAll" class="btn btn-small btn-info">üìÑ Export</button>
                    </div>
                </div>
                <div id="capturesList" class="captures-grid" role="list" aria-label="Recent captures list"></div>
            </section>

            <!-- Voice Commands Help -->
            <section class="help-section" role="region" aria-labelledby="help-heading">
                <h2 id="help-heading">Voice Commands (Coming Soon)</h2>
                <details class="help-details">
                    <summary>Available Voice Commands</summary>
                    <div class="help-content">
                        <ul>
                            <li>"Capture screen" - Take a screenshot</li>
                            <li>"Start recording" - Begin screen recording</li>
                            <li>"Stop recording" - End current recording</li>
                            <li>"Analyze capture" - Run AI analysis on current capture</li>
                            <li>"Read description" - Speak the AI analysis aloud</li>
                            <li>"Save capture" - Save current capture to storage</li>
                            <li>"Clear all" - Remove all saved captures</li>
                            <li>"Speak status" - Announce current system status</li>
                        </ul>
                        <p><strong>Note:</strong> Voice commands will be enabled once speech recognition permissions are granted.</p>
                    </div>
                </details>
            </section>

            <!-- Processing Status -->
            <div class="processing-status" id="processingStatus" style="display: none;" role="status" aria-live="polite" aria-label="Processing status"></div>

            <!-- AI Conversation Interface -->
            <div class="ai-conversation" id="aiConversation" style="display: none;" role="region" aria-labelledby="conversation-heading">
                <h3 id="conversation-heading">AI Conversation</h3>
                <div class="conversation-messages" id="conversationMessages" role="log" aria-live="polite" aria-label="AI conversation messages"></div>
                <div class="conversation-input-container">
                    <label for="aiInput">Ask AI about the capture:</label>
                    <input type="text" id="aiInput" class="ai-input" placeholder="Type your question here..." aria-describedby="ai-input-desc">
                    <button id="sendAiMessage" class="btn btn-primary">Send Question</button>
                </div>
                <p id="ai-input-desc">Ask questions about the current capture or analysis</p>
            </div>


            <!-- Enhanced Bottom Status Bar -->
            <div class="bottom-status-bar">
                <!-- Left Section - System Stats -->
                <div class="status-left">
                    <div class="status-item">
                        <span class="status-label">Storage:</span>
                        <span class="status-value" id="storageUsed">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Memory:</span>
                        <span class="status-value" id="memoryUsage">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Captures:</span>
                        <span class="status-value" id="capturesCount">-</span>
                    </div>
                </div>

                <!-- Center Section - Current Activity & Progress -->
                <div class="status-center">
                    <div class="activity-row">
                        <span id="currentActivity" class="current-activity">Ready</span>
                    </div>
                    <div class="progress-row">
                        <!-- Compact Analysis Progress -->
                        <div class="mini-progress-container">
                            <div class="mini-progress-track">
                                <div id="miniAnalysisProgressBar" class="mini-progress-bar" style="width: 0%"></div>
                            </div>
                            <span id="miniProgressText" class="mini-progress-text">Ready</span>
                        </div>

                        <!-- Compact AI Stats -->
                        <div class="mini-ai-stats">
                            <span class="mini-stat" id="miniTotalRequests">AI: 0</span>
                            <span class="mini-stat success-rate" id="miniSuccessRate">100%</span>
                        </div>
                    </div>
                </div>

                <!-- Right Section - Controls & Recent Announcements -->
                <div class="status-right">
                    <div class="status-controls">
                        <button id="speakStatus" class="btn btn-info btn-small" aria-describedby="speak-status-desc">
                            üîä Speak Status
                        </button>
                        <button id="quickHelp" class="btn btn-secondary btn-small" title="Quick Help">
                            ‚ùì Help
                        </button>
                    </div>

                    <!-- Compact Announcements -->
                    <div class="mini-announcements">
                        <div class="mini-announcements-header">
                            <span class="announcements-label">üì¢</span>
                            <span class="announcements-count" id="announcementsCount">0</span>
                        </div>
                        <div class="mini-announcements-list" id="miniAnnouncementsList">
                            <div class="mini-announcement-item">System ready</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Lines Under Status Bar -->
            <div class="status-extension-lines">
                <div class="extension-line primary-line">
                    <span class="line-label">System Status:</span>
                    <span class="line-content" id="systemStatusLine">All systems operational</span>
                </div>
                <div class="extension-line secondary-line">
                    <span class="line-label">Active Tasks:</span>
                    <span class="line-content" id="activeTasksLine">No active tasks</span>
                </div>
            </div>

            <!-- Enhanced Announcements Section (Moved Here) -->
            <div class="enhanced-announcements" role="region" aria-labelledby="announcements-heading">
                <div class="announcements-header">
                    <h3 id="announcements-heading">üì¢ Recent Announcements & Activity Log</h3>
                    <div class="announcements-controls">
                        <button id="clearAnnouncements" class="btn btn-small btn-secondary">üóëÔ∏è Clear</button>
                        <button id="pauseAnnouncements" class="btn btn-small btn-info">‚è∏Ô∏è Pause</button>
                        <button id="exportAnnouncements" class="btn btn-small btn-primary">üìÑ Export</button>
                    </div>
                </div>
                <div class="announcements-content">
                    <div class="announcements-list" id="announcementsList" role="log" aria-live="polite" aria-label="Recent announcements and activity">
                        <div class="announcement-item system-ready">
                            <span class="announcement-time">08:07</span>
                            <span class="announcement-type system">System</span>
                            <span class="announcement-message">Rapture Accessible initialized and ready</span>
                        </div>
                        <div class="announcement-item capture-ready">
                            <span class="announcement-time">08:07</span>
                            <span class="announcement-type ready">Ready</span>
                            <span class="announcement-message">All capture methods available</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom-Up Expandable Tools Section -->
            <div class="bottom-tools-section">
                <div class="tools-expander">
                    <button class="tools-toggle-btn" id="toolsToggle" aria-expanded="false" aria-controls="toolsContent">
                        <span class="toggle-icon">üîß</span>
                        <span class="toggle-text">Tools & Features</span>
                        <span class="toggle-arrow">‚ñ≤</span>
                    </button>
                    <div class="tools-content" id="toolsContent" style="display: none;">
                        <!-- Tool Features & Description -->
                        <section class="tool-features-section" role="region" aria-labelledby="features-heading">
                            <div class="section-header" id="features-heading">
                                <h3>üîß Tool Features & Description</h3>
                            </div>
                            <div class="features-grid">
                                <div class="feature-card">
                                    <h4>üì∏ Screen Capture</h4>
                                    <p>Manual and automatic screen capture with customizable timing and count settings.</p>
                                </div>
                                <div class="feature-card">
                                    <h4>üé• Video Recording</h4>
                                    <p>Record screen activity with start/stop controls and live preview functionality.</p>
                                </div>
                                <div class="feature-card">
                                    <h4>ü§ñ AI Analysis</h4>
                                    <p>Multiple AI providers (Gemini, Hugging Face, OpenAI) for intelligent content analysis.</p>
                                </div>
                                <div class="feature-card">
                                    <h4>üîä Accessibility</h4>
                                    <p>Full screen reader support, voice commands, and high contrast interface.</p>
                                </div>
                                <div class="feature-card">
                                    <h4>üíæ Data Management</h4>
                                    <p>Save, export, and manage captures with local storage and ZIP export.</p>
                                </div>
                                <div class="feature-card">
                                    <h4>‚ö° Automation</h4>
                                    <p>Sequential actions, auto-capture, and batch processing capabilities.</p>
                                </div>
                            </div>
                        </section>

                        <!-- Solutions Guide -->
                        <section class="solutions-guide-section" role="region" aria-labelledby="solutions-heading">
                            <div class="section-header" id="solutions-heading">
                                <h3>üí° Solutions Guide</h3>
                            </div>
                            <div class="solutions-container">
                                <div class="solutions-tabs">
                                    <button class="solution-tab active" data-tab="common-issues">Common Issues</button>
                                    <button class="solution-tab" data-tab="error-codes">Error Codes</button>
                                    <button class="solution-tab" data-tab="troubleshooting">Troubleshooting</button>
                                    <button class="solution-tab" data-tab="best-practices">Best Practices</button>
                                </div>
                                <div class="solutions-content">
                                    <div id="common-issues" class="solution-tab-content active">
                                        <h4>Common Issues & Solutions</h4>
                                        <div class="issue-item">
                                            <h5>üî¥ Screen Capture Fails</h5>
                                            <p><strong>Solution:</strong> Check browser permissions for screen capture. Ensure you're using HTTPS or localhost.</p>
                                        </div>
                                        <div class="issue-item">
                                            <h5>üü° AI Analysis Timeout</h5>
                                            <p><strong>Solution:</strong> Check internet connection. Try switching AI providers in settings.</p>
                                        </div>
                                        <div class="issue-item">
                                            <h5>üîµ Voice Commands Not Working</h5>
                                            <p><strong>Solution:</strong> Grant microphone permissions and ensure browser supports speech recognition.</p>
                                        </div>
                                    </div>
                                    <div id="error-codes" class="solution-tab-content">
                                        <h4>Error Code Reference</h4>
                                        <div class="error-item">
                                            <h5>ERR_CAPTURE_FAILED (1001)</h5>
                                            <p>Screen capture permission denied or not available.</p>
                                        </div>
                                        <div class="error-item">
                                            <h5>ERR_AI_TIMEOUT (2001)</h5>
                                            <p>AI service request timed out. Check connection.</p>
                                        </div>
                                        <div class="error-item">
                                            <h5>ERR_STORAGE_FULL (3001)</h5>
                                            <p>Local storage quota exceeded. Clear old captures.</p>
                                        </div>
                                    </div>
                                    <div id="troubleshooting" class="solution-tab-content">
                                        <h4>Troubleshooting Steps</h4>
                                        <ol class="troubleshooting-list">
                                            <li>Check browser console for error messages</li>
                                            <li>Verify all permissions are granted</li>
                                            <li>Test with a simple capture first</li>
                                            <li>Check internet connectivity</li>
                                            <li>Try different AI provider if analysis fails</li>
                                        </ol>
                                    </div>
                                    <div id="best-practices" class="solution-tab-content">
                                        <h4>Best Practices</h4>
                                        <ul class="best-practices-list">
                                            <li>Use HTTPS or localhost for screen capture</li>
                                            <li>Grant all necessary permissions upfront</li>
                                            <li>Keep browser updated for latest features</li>
                                            <li>Clear storage regularly to prevent quota issues</li>
                                            <li>Test voice commands in quiet environment</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Console Output Watch -->
                        <section class="console-watch-section" role="region" aria-labelledby="console-heading">
                            <div class="section-header" id="console-heading">
                                <h3>üñ•Ô∏è Console Output Monitor</h3>
                            </div>
                            <div class="console-controls">
                                <button id="clearConsole" class="btn btn-small btn-secondary">üóëÔ∏è Clear Console</button>
                                <button id="toggleConsole" class="btn btn-small btn-info">‚è∏Ô∏è Pause Monitoring</button>
                                <button id="exportConsole" class="btn btn-small btn-primary">üìÑ Export Logs</button>
                            </div>
                            <div class="console-output">
                                <div class="console-header">
                                    <span class="console-title">Live Console Output</span>
                                    <span class="console-stats">
                                        <span id="errorCount" class="error-count">Errors: 0</span>
                                        <span id="warningCount" class="warning-count">Warnings: 0</span>
                                        <span id="infoCount" class="info-count">Info: 0</span>
                                    </span>
                                </div>
                                <div id="consoleLog" class="console-log" role="log" aria-live="polite" aria-label="Console output log"></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Load JavaScript modules -->
    <script src="js/accessibility.js"></script>
    <script src="js/voice-commands.js"></script>
    <script src="js/auto-capture.js"></script>
    <script src="js/ai-analyzer.js"></script>
    <script src="js/capture-manager.js"></script>
    <script src="js/main.js"></script>
</body>
</html>